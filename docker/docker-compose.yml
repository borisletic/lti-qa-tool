# docker-compose.yml
# IZMENE vs originala:
#   - uklonjeni `version` (obsolete, Docker Compose v2 ignorisanje)
#   - canvas: cap_add SYS_KILL (popravka tini "Operation not permitted")
#   - canvas: restart: unless-stopped (prekinja beskonačan crash-loop)
#   - canvas: depends_on sa condition: service_healthy za postgres i redis
#   - canvas: eksplicitno RAILS_ENV=production
#   - postgres: fiksne kredensiale usklađene sa database.yml
#   - dodana canvas-setup servis za db:migrate + db:seed (mora trčiti PRE canvas)
#   - lti_tool/chroma/fuseki: dodato restart: unless-stopped

services:
  # ==========================================
  # PostgreSQL Database for Canvas
  # ==========================================
  # MORA biti zdrav pre što Canvas startuje
  postgres:
    image: postgres:11-alpine
    container_name: canvas-postgres
    environment:
      # OVA LOZINKA MORA BITI IDENTIČNA sa database.yml
      POSTGRES_DB: canvas
      POSTGRES_USER: canvas
      POSTGRES_PASSWORD: canvas_pg_pass_123
      # KRITIČNO: Canvas image ima libpq < 10 — ne podržava SCRAM-SHA-256.
      # md5 auth je jedina opcija koja radi sa tom verziom libpq.
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - lms_network
    healthcheck:
      # pg_isready sa eksplicitnim user-om
      test: ["CMD-SHELL", "pg_isready -U canvas -d canvas"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  # ==========================================
  # Redis Cache for Canvas
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: canvas-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - lms_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ==========================================
  # Canvas Setup (db:create + db:migrate + db:seed)
  # Radi JEDNOM, posle toga se ukloni sa `--rm`
  # ==========================================
  canvas-setup:
    image: instructure/canvas-lms:stable
    container_name: canvas-setup
    entrypoint: []   # overajde default entrypoint
    # Migracioni komanda - db:create je bezbedan ak DB već postoji
    command:
      - bash
      - -c
      - |
        echo "=== [canvas-setup] Čekanje na PostgreSQL ==="
        until pg_isready -h postgres -U canvas -d canvas; do
          echo "  -> postgres nije spreman, čekam 3s..."
          sleep 3
        done

        echo "=== [canvas-setup] Kreiranje baze ==="
        bundle exec rake db:create 2>/dev/null || true

        echo "=== [canvas-setup] Pokretanje migracija ==="
        bundle exec rake db:migrate
        echo "=== [canvas-setup] Kreiranje default account-a ==="
        bundle exec rake db:create_default_accounts
        echo "=== [canvas-setup] Ucitavanje initial data ==="
        bundle exec rake db:load_initial_data
        echo "=== [canvas-setup] Gotovo ==="
    environment:
      RAILS_ENV: production
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: canvas_pg_pass_123
      REDIS_HOST: redis
      CANVAS_LMS_ACCOUNT_NAME: FTN Test Institution
      CANVAS_LMS_ADMIN_EMAIL: admin@example.com
      CANVAS_LMS_ADMIN_PASSWORD: canvasadmin123
    volumes:
      - ./canvas-config/database.yml:/usr/src/app/config/database.yml:ro
      - ./canvas-config/security.yml:/usr/src/app/config/security.yml:ro
      - ./canvas-config/domain.yml:/usr/src/app/config/domain.yml:ro
      - ./canvas-config/outgoing_mail.yml:/usr/src/app/config/outgoing_mail.yml:ro
      # Monkey-patch: send_later_if_production_enqueue_args -> synchronous.
      # Eliminise max_concurrent error na SVE migracije odjednom.
      - ./canvas-patches/skip_delayed_jobs_in_migrations.rb:/usr/src/app/config/initializers/skip_delayed_jobs_in_migrations.rb:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lms_network

  # ==========================================
  # Canvas LMS Platform
  # ==========================================
  canvas:
    image: instructure/canvas-lms:stable
    container_name: canvas-lms
    ports:
      - "3000:80"
    # cap_add SYS_KILL uklonjeno — Docker Desktop Windows ne podrzava.
    restart: unless-stopped
    environment:
      RAILS_ENV: production
      # Kredensiali za Canvas initial setup (koristi se samo pri prvom boot-u)
      CANVAS_LMS_ADMIN_EMAIL: admin@example.com
      CANVAS_LMS_ADMIN_PASSWORD: canvasadmin123
      CANVAS_LMS_ACCOUNT_NAME: FTN Test Institution
      CANVAS_LMS_STATS_COLLECTION: opt_out
      # DB/Cache konektivnost
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: canvas_pg_pass_123
      REDIS_HOST: redis
    volumes:
      - canvas_data:/var/canvas
      - ./canvas-config/database.yml:/usr/src/app/config/database.yml:ro
      - ./canvas-config/security.yml:/usr/src/app/config/security.yml:ro
      - ./canvas-config/domain.yml:/usr/src/app/config/domain.yml:ro
      - ./canvas-config/outgoing_mail.yml:/usr/src/app/config/outgoing_mail.yml:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      # Canvas ne startuje do setup-a ne završava
      canvas-setup:
        condition: service_completed_successfully
    networks:
      - lms_network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80/health_check"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s

  # ==========================================
  # LTI Q&A Tool Provider
  # ==========================================
  lti_tool:
    build:
      context: ../lti-tool
      dockerfile: Dockerfile
    container_name: lti-qa-tool
    ports:
      - "5000:5000"
    restart: unless-stopped
    environment:
      FLASK_APP: app.py
      FLASK_ENV: ${FLASK_ENV:-development}
      FLASK_SECRET_KEY: ${FLASK_SECRET_KEY:-dev-secret-change-in-prod}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      LTI_KEY: ${LTI_KEY:-default_lti_key}
      LTI_SECRET: ${LTI_SECRET:-default_lti_secret}
      CHROMA_HOST: chroma
      CHROMA_PORT: "8000"
      FUSEKI_URL: http://fuseki:3030
      OLLAMA_HOST: http://ollama:11434
    volumes:
      - ../lti-tool:/app
      - vector_db_data:/app/data
      - ../ontology:/app/ontology:ro
    depends_on:
      - chroma
      - fuseki
    networks:
      - lms_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # ChromaDB Vector Database
  # ==========================================
  chroma:
    image: ghcr.io/chroma-core/chroma:latest
    container_name: chromadb
    ports:
      - "8001:8000"
    restart: unless-stopped
    environment:
      IS_PERSISTENT: "TRUE"
      # Uklonjen auth za development -- lakše testiranje
      # Za produkciju vrati token-based auth
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - lms_network
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/8000"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ==========================================
  # Apache Jena Fuseki SPARQL Server (NO AUTH)
  # ==========================================
  fuseki:
    image: stain/jena-fuseki:latest
    container_name: jena-fuseki
    ports:
      - "3030:3030"
    restart: unless-stopped
    environment:
      JVM_ARGS: -Xmx2g
    volumes:
      - fuseki_data:/fuseki
      - ../ontology:/ontology:ro
    networks:
      - lms_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/$/ping"]
      interval: 15s
      timeout: 5s
      retries: 3
    entrypoint:
      - sh
      - -c
      - |
        # Kreiraj TDB2 dataset ako ne postoji
        mkdir -p /fuseki/databases/lms-tools
        
        # Kopiraj ontologiju ako postoji
        if [ -f /ontology/lms-tools.ttl ]; then
          cp /ontology/lms-tools.ttl /fuseki/databases/lms-tools/data.ttl
        fi
        
        # Pokreni Fuseki BEZ autentifikacije (--auth=disabled)
        exec /jena-fuseki/fuseki-server --tdb2 --loc=/fuseki/databases/lms-tools --update /lms-tools
  

  # ==========================================
  # Ollama - Local LLM Server
  # ==========================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - lms_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================
  # Nginx Reverse Proxy (Optional - production)
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - canvas
      - lti_tool
    networks:
      - lms_network
    profiles:
      - production

  # ==========================================
  # Adminer - Database Management (dev)
  # ==========================================
  adminer:
    image: adminer:latest
    container_name: adminer
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    networks:
      - lms_network
    profiles:
      - dev

# ==========================================
# VOLUMES
# ==========================================
volumes:
  canvas_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  vector_db_data:
    driver: local
  chroma_data:
    driver: local
  fuseki_data:
    driver: local
  ollama_data:
    driver: local

# ==========================================
# NETWORKS
# ==========================================
networks:
  lms_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
